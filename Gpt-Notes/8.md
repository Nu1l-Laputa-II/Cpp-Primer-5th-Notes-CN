# 第8章 IO库 - 总结笔记

---

## **1. IO库基础**

### **1.1 常见IO类型与对象**
- **输入流类型：** `istream` 用于读取数据（标准输入：`cin`）。
- **输出流类型：** `ostream` 用于写入数据（标准输出：`cout`；标准错误：`cerr`）。
- **文件流类型：**
  - `ifstream`：从文件读取数据。
  - `ofstream`：向文件写入数据。
  - `fstream`：同时支持读写文件。
- **字符串流类型：**
  - `istringstream`：从`string`读取数据。
  - `ostringstream`：向`string`写入数据。
  - `stringstream`：支持同时读写`string`。

### **1.2 IO运算符与函数**
- **输入运算符 `>>`：** 从流中读取数据。
- **输出运算符 `<<`：** 向流中写入数据。
- **`getline`函数：** 读取一整行输入并存入`string`对象。
  ```c++
  string line;
  getline(cin, line);  // 从标准输入读取一行
  ```

### **1.3 常见头文件**
| 头文件       | 功能                   |
|--------------|------------------------|
| `iostream`   | 提供标准输入输出流。   |
| `fstream`    | 提供文件输入输出流。   |
| `sstream`    | 提供字符串输入输出流。 |

---

## **2. IO类的特性**

### **2.1 IO对象不可拷贝或赋值**
- **规则：** IO对象不能被拷贝或赋值，只能通过引用传递。
  ```c++
  ofstream out1, out2;
  out1 = out2;  // 错误：不能对流对象赋值
  ```

### **2.2 IO流的条件状态**
- **条件状态的标志：**
  - **`badbit`：** 流发生不可恢复的系统错误。
  - **`failbit`：** IO操作失败（如读入类型不匹配）。
  - **`eofbit`：** 到达输入流末尾。
  - **`goodbit`：** 流状态正常（值为`0`）。
- **流状态检测函数：**
  | 函数               | 含义                           |
  |--------------------|--------------------------------|
  | `s.good()`         | 检查流是否处于有效状态。       |
  | `s.fail()`         | 检查`failbit`或`badbit`是否置位。 |
  | `s.eof()`          | 检查`eofbit`是否置位。         |
  | `s.bad()`          | 检查`badbit`是否置位。         |
  - 示例：
    ```c++
    if (cin.fail()) {
        cout << "IO操作失败！" << endl;
    }
    ```

- **流状态管理函数：**
  - `rdstate()`：返回当前流状态。
  - `clear()`：清除所有错误标志，将流置为有效状态。
  - `setstate(flags)`：设置流的指定条件。
    ```c++
    cin.clear();  // 清除错误状态
    cin.setstate(ios::failbit);  // 设置 failbit
    ```

### **2.3 输出缓冲区管理**
- **缓冲区刷新条件：**
  - 缓冲区满时。
  - 显式调用刷新操作（如`endl`）。
  - 程序正常结束时。
  - 通过`unitbuf`操纵符设置流的自动刷新模式。
    ```c++
    cout << unitbuf;  // 每次输出后立即刷新缓冲区
    cout << nounitbuf;  // 恢复正常缓冲
    ```
- **常用操纵符：**
  | 操纵符   | 功能                              |
  |----------|-----------------------------------|
  | `endl`   | 输出换行并刷新缓冲区。            |
  | `flush`  | 刷新缓冲区但不输出额外字符。      |
  | `ends`   | 输出一个空字符并刷新缓冲区。      |

---

## **3. 文件输入输出**

### **3.1 文件流类型与操作**
- **文件流类型：** `ifstream`、`ofstream`、`fstream`。
- **常用操作：**
  | 操作                | 含义                                |
  |---------------------|-------------------------------------|
  | `fstream fstrm(s)`  | 打开文件`s`，默认模式根据流类型设置。 |
  | `fstrm.open(s)`     | 打开文件`s`并与流关联。              |
  | `fstrm.close()`     | 关闭流关联的文件。                   |
  | `fstrm.is_open()`   | 检查文件是否成功打开。               |

- **示例：**
  ```c++
  ifstream inFile("data.txt");  // 打开文件用于读取
  ofstream outFile("result.txt");  // 打开文件用于写入
  if (!inFile.is_open()) {
      cerr << "无法打开文件！" << endl;
  }
  ```

### **3.2 文件模式**
- **文件模式常量：**
  | 模式      | 含义                       |
  |-----------|----------------------------|
  | `in`      | 以读模式打开文件（默认）。  |
  | `out`     | 以写模式打开文件（默认）。  |
  | `app`     | 每次写操作前定位到文件末尾。|
  | `ate`     | 打开文件后立即定位末尾。    |
  | `trunc`   | 打开文件时清空文件内容。    |
  | `binary`  | 以二进制模式打开文件。      |

- **模式组合：**
  - 默认情况下，`ofstream`使用`out | trunc`。
  - 如果想保留原内容，可用`out | app`或`out | in`。
  ```c++
  ofstream out("log.txt", ofstream::app);  // 追加模式
  ```

### **3.3 文件流的关闭与错误处理**
- **关闭文件：** 调用`close`函数关闭文件。
- **错误处理：** 使用`fail()`等函数检测文件流状态。

---

## **4. 字符串流**

### **4.1 `stringstream`的作用**
- 允许在内存中的`string`上执行IO操作。
- 提供`istringstream`（输入）、`ostringstream`（输出）、`stringstream`（同时输入输出）三种类型。

### **4.2 常用操作**
- 构造与绑定：
  ```c++
  istringstream iss("example data");  // 绑定字符串
  ostringstream oss;  // 初始化空字符串流
  ```
- 获取或设置流中的字符串：
  | 操作             | 含义                       |
  |------------------|----------------------------|
  | `str()`          | 返回当前流中的字符串。      |
  | `str(const s&)`  | 用`s`替换当前流中的字符串。 |

- **示例：读取和格式化数据**
  ```c++
  string data = "John 123 456";
  istringstream iss(data);
  string name;
  int val1, val2;
  iss >> name >> val1 >> val2;  // 从字符串流中读取数据
  ```

---

## **5. 关联流**

### **5.1 流的关联与`tie`**
- **流关联的目的：** 使一个流的操作触发另一个流的缓冲区刷新。
  - 默认情况下，`cin`与`cout`关联。
- **`tie`函数：**
  - `cin.tie()`：返回当前关联的`ostream`。
  - `cin.tie(&cout)`：将`cin`与`cout`关联。

```c++
cin.tie(&cout);  // 读取 cin 时刷新 cout
cin.tie(nullptr);  // 解开 cin 与 cout 的关联
```

---

## **6. 输入输出的高级用法**

### **6.1 格式化IO**
- **控制输出格式：**
  - 头文件：`iomanip`。
  - 常用操纵符：
    | 操纵符       | 含义                         |
    |--------------|------------------------------|
    | `setw(n)`    | 设置字段宽度为`n`。           |
    | `setprecision(n)` | 设置浮点数精度为`n`位。  |
    | `fixed`      | 固定小数点表示法。           |
    | `scientific` | 科学计数法表示法。           |
    | `left`、`right` | 左对齐或右对齐。           |

  ```c++
  double pi = 3.14159;
  cout << setprecision(3) << pi << endl;  // 输出 3.14
  ```

### **6.2 异常处理**
- **流操作的异常处理：**
  - 设置流的异常掩码：
    ```c++
    cin.exceptions(ios::failbit | ios::badbit);
    ```

- 使用`try-catch`捕获异常：
  ```c++
  try {
      cin >> val;
  } catch (ios::failure &e) {
      cerr << "IO操作失败：" << e.what() << endl;
  }
  ```

---

## **总结**
- IO库提供了多种流类型，用于操作标准输入输出、文件和字符串。
- 使用流的条件状态和错误管理函数，可以灵活地控制和检测输入输出过程。
- 文件流和字符串流扩展了IO库的功能，支持对文件和内存数据的操作。
- 格式化输出和异常处理使得IO操作更加灵活和安全。